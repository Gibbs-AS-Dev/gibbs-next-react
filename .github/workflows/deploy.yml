name: Deploy Next.js to Gibbs (Zero Downtime)

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build & Deploy Next.js (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Install sshpass for password-based SSH authentication
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      # Deploy files to the remote server using rsync with password authentication
      - name: Deploy Next.js files to server using rsync
        run: |
          echo "ðŸš€ Deploying files to server..."
          sshpass -p "${{ secrets.DEV_PASSWORD }}" rsync -avzh --exclude=".git" --exclude="node_modules" -e "ssh -o StrictHostKeyChecking=no" ./ ${{ secrets.DEV_USERNAME }}@${{ secrets.HOST }}:/var/www/vhosts/dev.gibbs.no/nextjs.dev.gibbs.no

      # Execute remote commands via SSH using sshpass (with password)
      - name: Restart Docker Containers for Zero Downtime
        run: |
          echo "ðŸš€ Connecting via SSH to deploy..."
          sshpass -p "${{ secrets.DEV_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.DEV_USERNAME }}@${{ secrets.HOST }} << 'EOF'
            echo "ðŸš€ Deploying Next.js app with Docker Compose..."
            
            cd /var/www/vhosts/dev.gibbs.no/nextjs.dev.gibbs.no
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main || echo "âš ï¸ Git pull failed, skipping..."

            echo "ðŸš€ Starting new nextjs-prod container..."
            docker compose up --build -d nextjs-prod-new


            echo "ðŸ”Ž Waiting for the new container to be healthy..."
            sleep 10  # Adjust if necessary

            if docker ps --filter "name=nextjs-prod-new" --filter "status=running" | grep -q nextjs-prod-new; then
              echo "âœ… New container is running! Swapping traffic..."

              echo "ðŸ›‘ Stopping and Removing old nextjs-prod container..."
              docker ps -q --filter "name=nextjs-prod" | grep -q . && docker stop nextjs-prod && docker rm nextjs-prod || echo "No old nextjs-prod container found"

              echo "ðŸ”„ Renaming new container to nextjs-prod..."
              docker rename nextjs-prod-new nextjs-prod
            else
              echo "âŒ New container failed to start! Rolling back..."
              docker stop nextjs-prod-new && docker rm nextjs-prod-new
              exit 1
            fi

            echo "âœ… Deployment complete with zero downtime!"
          EOF
